<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><meta name="keywords" content="js, css, dom"><title>HTTP缓存 | fyt的博客</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">HTTP缓存</h1><a id="logo" href="/.">fyt的博客</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">HTTP缓存</h1><div class="post-meta"><a href="/2018/02/07/HTTP缓存/#comments" class="comment-count"></a><p><span class="date">Feb 07, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>最近在学习HTTP缓存，使用缓存是网站优化的重要步骤。本文是对《HTTP权威指南》第七章缓存的一些摘要和总结。</p>
<p>在商业应用中，使用缓存服务器来提高性能降低对原始服务器的要求。对一条HTTP GET报文的基本缓存处理过程包括7个步骤 ：</p>
<p>(1)  接收——缓存从网络中读取抵达的请求报文。<br>(2)  解析——缓存对报文进行解析，提取出 URL 和各种首部。<br>(3)  查询——缓存查看是否有本地副本可用，如果没有，就获取一份副本(并将其保存在本地)。<br>(4)  新鲜度检测——缓存查看已缓存副本是否足够新鲜，如果不是，就询问服务器是否有任何更新。<br>(5)  创建响应——缓存会用新的首部和已缓存的主体来构建一条响应报文。<br>(6)  发送——缓存通过网络将响应发回给客户端。<br>(7)  日志——缓存可选地创建一个日志文件条目来描述这个事务。</p>
<p>这个过程如下图所示：</p>
<p><img src="http1.png" alt=""></p>
<p>其中对于新鲜度检测这一步，HTTP协议有两个机制：文档过期和服务器再验证来保持缓存中副本的新鲜度。</p>
<h3 id="1、文档过期"><a href="#1、文档过期" class="headerlink" title="1、文档过期"></a>1、文档过期</h3><p>通过特殊的HTTP Cache-Control首部和Expires首部，HTTP让原始服务器向每个文档附加了一个“过期日期”。</p>
<p>Cache-Control首部和Expires首部告诉客户端到了某个时间点（比照客户端时间点）后本地缓存就过期了，在这个时间点内客户端可以认为缓存数据有效，可直接从缓存中加载展示返回200（强缓存），一旦资源命中强缓存，浏览器便不会向服务器发送请求，而是直接读取缓存。Chrome下的现象是200 OK (from disk cache) 或者 200 OK (from memory cache).</p>
<p>但一旦已缓存文档过期，缓存就必须与服务器进行核对，询问文档是否被修改过，如果文档被修改过，就要获取一份新鲜(带有新的过期日期)的副本。 </p>
<p>服务器用HTTP/1.0+的Expires首部或HTTP/1.1的<code>Cache-Control: max-age</code>响应首部来指定过期日期，同时还会带有响应主体。Expires首部和<code>Cache-Control: max-age</code>首部所做的事情本质上是一样的，但由于Cache-Control首部使用的是相对时间而不是绝对日期，所以我们更倾向于使用比较新的Cache-Control首部。 </p>
<p>Cache-Control在浏览器缓存中是金字塔顶尖的规则，它会覆盖一切与之相悖的规则。因此当Expires与之相悖时，就会忽略Expires。</p>
<h3 id="2、服务器再验证"><a href="#2、服务器再验证" class="headerlink" title="2、服务器再验证"></a>2、服务器再验证</h3><p>如果仅仅是Cache-Control首部和Expires首部规定的时间点过期了，那并不意味着它和原始服务器上目前正处于活跃状态的文档有实际区别。</p>
<p>这只是意味着到了要核对的时间了。这种情况被称为“服务器再验证”，说明缓存需要询问原始服务器文档是否发生了变化。如果再验证显示内容发生了变化，缓存会获取一份新的文档副本，并将其存储在旧文档的位置上，然后将文档发送给客户端。如果再验证显示内容没有发生变化，缓存只需要获取新的首部，包括一个新的过期日期，并对缓存中的首部进行更新就行了。 </p>
<p>客户端检测到数据过期后，会向服务器发送一个get请求。在请求中一般会携带If-Modified-Since或If-None-Match请求头。</p>
<p>先说If-Modified-Since。如果在指定日期之后资源发生了变化，GET请求就会成功执行返回200响应。携带新首部的新文档会被返回给缓<br>存，新首部除了其他信息之外，还包含了一个新的过期日期。 如果自指定日期后，文档没被修改过，会向客户端返回一个304 Not Modified 响应报文，为了提高有效性，不会返回文档的主体。这些首部是放在响应中返回的，但只会返回那些需要在源端更新的首部。比如，Content-Type 首部通常不会被修改，所以通常不需要发送。一般会发送一个新的过期日期。 </p>
<p>再说If-None-Match。有些情况下仅使用最后修改日期进行再验证是不够的。 比如：</p>
<p>(1)  有些文档可能会被周期性地重写(比如，从一个后台进程中写入)，但实际包含的数据常常是一样的。尽管内容没有变化，但修改日期会发生变化。<br>(2)  再比如有些文档可能被修改了，但所做修改并不重要，不需要让世界范围内的缓存都重装数据(比如对拼写或注释的修改)。<br>(3)  有些服务器无法准确地判定其页面的最后修改日期。<br>(4)  有些服务器提供的文档会在亚秒间隙发生变化(比如，实时监视器)，对这些服务器来说，以一秒为粒度的修改日期可能就不够用了。 </p>
<p>在这些情况下HTTP允许用户对被称为实体标签(ETag)的“版本标识符” 进行比较。实体标签是附加到文档上的任意标签(引用字符串)。它们可能包含了文档的序列号或版本名，或者是文档内容的校验和及其他指纹信息。</p>
<p>当发布者对文档进行修改时，可以修改文档的实体标签来说明这个新的版本。这样，如果实体标签被修改了，缓存就可以用 If-None-Match 条件首部收到一条200已缓存的成功响应，返回新的内容以及相应的新 Etag。当实体标签没有被修改，就会返回304未修改响应。</p>
<p>如果 HTTP/1.1 缓存或服务器收到的请求既带有 If-Modified-Since，又带有实体标签条件首部ETag，那么只有这两个条件都满足时，才能返回 304 Not Modified 响应。</p>
<p>HTTP规范从未指定生成ETag的方法。生成ETag常用的方法包括对资源内容使用抗碰撞散列函数，使用最近修改的时间戳的哈希值，甚至只是一个版本号。</p>
<h3 id="3、关于Cache-Control"><a href="#3、关于Cache-Control" class="headerlink" title="3、关于Cache-Control"></a>3、关于Cache-Control</h3><p>服务器可以通过 HTTP 定义的几种方式来指定在文档过期之前可以将其缓存多长时间。按照优先级递减的顺序，服务器可以: </p>
<p>附加一个Cache-Control:no-store首部到响应中去;</p>
<p>附加一个Cache-Control:no-cache首部到响应中去;</p>
<p>附加一个Cache-Control:must-revalidate首部到响应中去; </p>
<p>附加一个Cache-Control:max-age首部到响应中去;</p>
<p>附加一个Expires日期首部到响应中去;</p>
<p>不附加过期信息，让缓存确定自己的过期日期。</p>
<p>标识为 no-store 的响应会禁止缓存对响应进行复制。缓存通常会像非缓存代理服务器一样，向客户端转发一条 no-store 响应，然后删除对象。 </p>
<p>标识为 no-cache 的响应实际上是可以存储在本地缓存区中的。只是在与原始服务器进行新鲜度再验证之前，缓存不能将其提供给客户端使用。 我的理解是no-cache是表示max-age=0即立马过期。</p>
<p><code>Cache-Control: max-age</code>首部表示的是从服务器将文档传来之时起，可以认为此文档处于新鲜状态的秒数 。</p>
<h3 id="4、关于Expires响应首部"><a href="#4、关于Expires响应首部" class="headerlink" title="4、关于Expires响应首部"></a>4、关于Expires响应首部</h3><p>不推荐使用 Expires 首部，它指定的是实际的过期日期而不是秒数。HTTP 设计者后来认为，由于很多服务器的时钟都不同步，或者不正确，所以最好还是用剩余秒数，而不是绝对时间来表示过期时间。</p>
<h3 id="5、当响应中没有Cache-Control-max-age首部，也没有-Expires-首部时"><a href="#5、当响应中没有Cache-Control-max-age首部，也没有-Expires-首部时" class="headerlink" title="5、当响应中没有Cache-Control: max-age首部，也没有 Expires 首部时"></a>5、当响应中没有<code>Cache-Control: max-age</code>首部，也没有 Expires 首部时</h3><p>如果响应中没有<code>Cache-Control: max-age</code>首部，也没有 Expires 首部，那么使用LM-Factor 算法 的试探性过期算法，用当前时间Date与文档的最后修改时间之差，取这个间隔时间的一部分，将其作为缓存中的新鲜度持续时间。</p>
<h3 id="6、用户操作行为与缓存"><a href="#6、用户操作行为与缓存" class="headerlink" title="6、用户操作行为与缓存"></a>6、用户操作行为与缓存</h3><p>用户在使用浏览器的时候，会有各种操作，比如输入地址后回车，按F5刷新等，这些行为会对缓存有什么影响呢？</p>
<p><img src="http2.png" alt=""></p>
<p>通过上表我们可以看到，当用户在按F5进行刷新的时候，会忽略Expires/Cache-Control的设置，会再次发送请求去服务器请求，而Last-Modified/Etag还是有效的，服务器会根据情况判断返回304还是200；而当用户使用Ctrl+F5进行强制刷新的时候，只是所有的缓存机制都将失效，重新从服务器拉去资源。</p>
</div><div class="tags"></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2018/08/13/Promise理解进阶篇/" class="pre">Promise理解进阶篇</a><a href="/2018/01/28/DOM中外部资源的解析与优化/" class="next">DOM中外部资源的解析与优化</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、文档过期"><span class="toc-text">1、文档过期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、服务器再验证"><span class="toc-text">2、服务器再验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、关于Cache-Control"><span class="toc-text">3、关于Cache-Control</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、关于Expires响应首部"><span class="toc-text">4、关于Expires响应首部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、当响应中没有Cache-Control-max-age首部，也没有-Expires-首部时"><span class="toc-text">5、当响应中没有Cache-Control: max-age首部，也没有 Expires 首部时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、用户操作行为与缓存"><span class="toc-text">6、用户操作行为与缓存</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/15/HTTP杂说/">HTTP杂说</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/13/Promise理解进阶篇/">Promise理解进阶篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/07/HTTP缓存/">HTTP缓存</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/28/DOM中外部资源的解析与优化/">DOM中外部资源的解析与优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/06/Promise/">Promise理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/bind函数/">bind函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/08/CSS中的BFC/">CSS中的BFC</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/20/全排列/">全排列</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/04/快速排序/">快速排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/27/transition/">CSS3 transition</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/DOM/" style="font-size: 15px;">DOM</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-na33me1" target="_blank">site-na33me1</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">fyt.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>